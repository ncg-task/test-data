title
DSFD: Dual Shot Face Detector
abstract
In this paper, we propose a novel face detection network with three novel contributions that address three key aspects of face detection, including better feature learning, progressive loss design and anchor assign based data augmentation, respectively. First, we propose a Feature Enhance Module (FEM) for enhancing the original feature maps to extend the single shot detector to dual shot detector. Second, we adopt Progressive Anchor Loss (PAL) computed by two different sets of anchors to effectively facilitate the features. Third, we use an Improved Anchor Matching (IAM) by integrating novel anchor assign strategy into data aug-
Introduction
Face detection is a fundamental step for various facial applications, like face alignment, parsing, recognition, and verification. As the pioneering work for face detection, Viola-Jones adopts AdaBoost algorithm with hand-crafted features, which are now replaced by deeply learned features from the convolutional neural network (CNN) that achieves great progress. Although the CNN based face detectors have being extensively studied, detecting faces with high degree of variability in scale, pose, occlusion, expression, appearance and illumination in real-world scenarios remains a challenge.
Previous state-of-the-art face detectors can be roughly divided into two categories. The first one is mainly based on the Region Proposal Network (RPN) adopted in Faster RCNN and employs two stage detection schemes. RPN is trained end-to-end and generates highquality region proposals which are further refined by Fast R-CNN detector. The other one is Single Shot Detector (SSD) based one-stage methods, which get rid of RPN, and directly predict the bounding boxes and confidence. Recently, one-stage face detection framework has attracted more attention due to its higher inference efficiency and straightforward system deployment.
Despite the progress achieved by the above methods, there are still some problems existed in three aspects: Feature learning Feature extraction part is essential fora face detector. Currently, Feature Pyramid Network (FPN) is widely used in state-of-the-art face detectors for rich features. However, FPN just aggregates hierarchical feature maps between high and low-level output layers, which does not consider the current layer's information, and the context relationship between anchors is ignored. Loss design The conventional loss functions used in object detection include a regression loss for the face region and a classification loss for identifying if a face is detected or not. To further address the class imbalance problem, Lin et al. propose Focal Loss to focus training on a sparse set of hard examples. To use all original and enhanced features, propose Hierarchical Loss to effectively learn the network. However, the above loss functions do not consider progressive learning ability of feature maps in both of different levels and shots. Anchor matching Basically, pre-set anchors for each feature map are generated by regularly tiling a collection of boxes with different scales and aspect ratios on the image. Some works analyze a series of reasonable anchor scales and anchor compensation strategy to increase positive anchors. However, such strategy ignores random sampling in data augmentation, which still causes imbalance between positive and negative anchors.
In this paper, we propose three novel techniques to address the above three issues, respectively. First, we introduce a Feature Enhance Module (FEM) to enhance the discriminability and robustness of the features, which combines the advantages of the FPN in PyramidBox and Receptive Field Block (RFB) in RFBNet. Second, motivated by the hierarchical loss and pyramid anchor in PyramidBox, we design Progressive Anchor Loss (PAL) that uses progressive anchor sizes for not only different levels, but also different shots. Specifically, we assign smaller anchor sizes in the first shot, and use larger sizes in the second shot. Third, we propose Improved Anchor Matching (IAM), which integrates anchor partition strategy and anchor-based data augmentation to better match anchors and ground truth faces, and thus provides better initialization for the regressor. The three aspects are complementary so that these techniques can work together to further improve the performance. Besides, since these techniques are all related to two-stream design, we name the proposed network as Dual Shot Face Detector (DSFD). shows the effectiveness of DSFD on various variations, especially on extreme small faces or heavily occluded faces.
In summary, the main contributions of this paper include:
• A novel Feature Enhance Module to utilize different level information and thus obtain more discriminability and robustness features.
• Auxiliary supervisions introduced in early layers via a set of smaller anchors to effectively facilitate the features.
• An improved anchor matching strategy to match anchors and ground truth faces as far as possible to provide better initialization for the regressor.
• Comprehensive experiments conducted on popular benchmarks FDDB and WIDER FACE to demonstrate the superiority of our proposed DSFD network compared with the state-of-the-art methods.

Related work
We review the prior works from three perspectives. Feature Learning Early works on face detection mainly rely on hand-crafted features, such as Harr-like features, control point set, edge orientation histograms. However, hand-crafted features design is lack of guidance. With the great progress of deep learning, handcrafted features have been replaced by Convolutional Neural Networks (CNN). For example, Overfeat, Cascade-CNN, MTCNN adopt CNN as a sliding window detector on image pyramid to build feature pyramid. However, using an image pyramid is slow and memory inefficient. As the result, most two stage detectors extract features on single scale. R-CNN obtains region proposals by selective search, and then forwards each normalized image region through a CNN to classify. Faster R-CNN, R-FCN employ Region Proposal Network (RPN) to generate initial region proposals. Besides, ROIpooling and position-sensitive RoI pooling are applied to extract features from each region.
More recently, some research indicates that multi-scale features perform better for tiny objects. Specifically, SSD, MS-CNN, SSH, S3FD predict boxes on multiple layers of feature hierarchy. FCN, Hypercolumns, Parsenet fuse multiple layer features in segmentation. FPN, a top-down architecture, integrate high-level semantic information to all scales. FPN-based methods, such as FAN, PyramidBox achieve significant improvement on detection. However, these methods do not consider the current layers information. Different from the above methods that ignore the context relationship between anchors, we propose a feature enhance module that incorporates multi-level dilated convolutional layers to enhance the semantic of the features.
Loss Design Generally, the objective loss in detection is a weighted sum of classification loss (e.g. softmax loss) and box regression loss (e.g. L 2 loss). Girshick et al. propose smooth L 1 loss to prevent exploding gradients. Lin et al. discover that the class imbalance is one obstacle for better performance in one stage detector, hence they propose focal loss, a dynamically scaled cross entropy loss. Besides, Wang et al. design RepLoss for pedestrian detection, which improves performance in occlusion scenarios. FANet create a hierarchical feature pyramid and presents hierarchical loss for their architecture. However, the anchors used in FANet are kept the same size in different stages. In this work, we adaptively choose different anchor sizes in different stages to facilitate the features.
Anchor Matching To make the model more robust, most detection methods do data augmentation, such as color distortion, horizontal flipping, random crop and multiscale training. Zhang et al. propose an anchor compensation strategy to make tiny faces to match enough anchors during training. Wang et al. propose random crop to generate large number of occluded faces for training. However, these methods ignore random sampling in data augmentation, while ours combines anchor assign to provide better data initialization for anchor matching.

Dual Shot Face Detector
We firstly introduce the pipeline of our proposed framework DSFD, and then detailly describe our feature enhance module in Sec. 3.2, progressive anchor loss in Sec. 3.3 and improved anchor matching in Sec. 3.4, respectively.

Pipeline of DSFD
The framework of DSFD is illustrated in. Our architecture uses the same extended VGG16 backbone as PyramidBox and S3FD, which is truncated before the classification layers and added with some auxiliary structures. We select conv3 3, conv4 3, conv5 3, conv fc7, conv6 2 and conv7 2 as the first shot detection layers to generate six original feature maps named of 1 , of 2 , of 3 , of 4 , of 5 , of 6 . Then, our proposed FEM transfers these original feature maps into six enhanced feature maps named ef 1 , ef 2 , ef 3 , ef 4 , ef 5 , ef 6 , which have the same sizes as the original ones and are fed into SSD-style head to construct the second shot detection layers. Note that the input size of the training image is 640, which means the feature map size of the lowest-level layer to highest-level layer is from 160 to 5. Different from S3FD and Pyramid-Box, after we utilize the receptive field enlargement in FEM and the new anchor design strategy, its unnecessary for the three sizes of stride, anchor and receptive field to satisfy equal-proportion interval principle. Therefore, our DSFD is more flexible and robustness. Besides, the original and enhanced shots have two different losses, respectively named First Shot progressive anchor Loss (FSL) and Second Shot progressive anchor Loss (SSL).

Feature Enhance Module
Feature Enhance Module is able to enhance original features to make them more discriminable and robust, which is called FEM for short. For enhancing original neuron cell oc (i,j,l) , FEM utilizes different dimension information including upper layer original neuron cell oc (i,j,l) and current layer non-local neuron cells: nc (i??,j??,l) , nc (i??,j,l) , ..., nc (i,j+?,l) , nc (i+?,j+?,l) . Specially, the enhanced neuron cell ec (i,j,l) can be mathematically defined as follow:
where c i,j,l is a cell located in (i, j) coordinate of the feature maps in the l-th layer, f denotes a set of basic dilation convolution, elem-wise production, up-sampling or concatenation operations. illustrates the idea of FEM, which is inspired by FPN and RFB. Here, we first use 1×1 convolutional kernel to normalize the feature maps. Then, we up-sample upper feature maps to do element-wise product with the current ones. Finally, we split the feature maps to three parts, followed by three sub-networks containing different numbers of dilation convolutional layers.

Progressive Anchor Loss
Different from the traditional detection loss, we design progressive anchor sizes for not only different levels, but also different shots in our framework. Motivated by the statement in that low-level features are more suitable for small faces, we assign smaller anchor sizes in the first shot, and use larger sizes in the second shot. First, our Second Shot anchor-based multi-task Loss function is defined as:
where N conf and N loc indicate the number of positive and negative anchors, and the number of positive anchors respectively, L conf is the softmax loss over two classes (face vs. background), and L loc is the smooth L 1 loss between the parameterizations of the predicted box ti and ground-truth box g i using the anchor a i . When p * i = 1 (p * i = {0, 1}), the anchor a i is positive and the localization loss is activated. ? is a weight to balance the effects of the two terms. Compared to the enhanced feature maps in the same level, the original feature maps have less semantic information for classification but more high resolution location information for detection. Therefore, we believe that the original feature maps can detect and classify smaller faces. As the result, we propose the First Shot multi-task Loss with a set of smaller anchors as follows:
where sa indicates the smaller anchors in the first shot layers, and the two shots losses can be weighted summed into a whole Progressive Anchor Loss as follows:
Note that anchor size in the first shot is half of ones in the second shot, and ? is weight factor. Detailed assignment on the anchor size is described in Sec. 3.4. In prediction process, we only use the output of the second shot, which means no additional computational cost is introduced.

Improved Anchor Matching
Current anchor matching method is bidirectional between the anchor and ground-truth face. Therefore, anchor design and face sampling during augmentation are collaborative to match the anchors and faces as far as possible for better initialization of the regressor. Our IAM targets on addressing the contradiction between the discrete anchor scales and continuous face scales, in which the faces are augmented by S input * S face /S anchor (S indicates the spatial size) with the probability of 40% so as to increase the positive anchors, stabilize the training and thus improve the results. shows details of our anchor design on how each feature map cell is associated to the fixed shape anchor. We set anchor ratio 1.5:1 based on face scale statistics. Anchor size for the original feature is one half of the enhanced feature. Additionally, with   probability of 2/5, we utilize anchor-based sampling like data-anchor-sampling in PyramidBox, which randomly selects a face in an image, crops sub-image containing the face, and sets the size ratio between sub-image and selected face to 640/rand. For the remaining 3/5 probability, we adopt data augmentation similar to SSD. In order to improve the recall rate of faces and ensure anchor classification ability simultaneously, we set Intersection-over-Union (IoU) threshold 0.4 to assign anchor to its ground-truth faces.

Experiments

Implementation Details
First, we present the details in implementing our network. The backbone networks are initialized by the pretrained VGG/ResNet on ImageNet. All newly added convolution layers' parameters are initialized by the 'xavier' method. We use SGD with 0.9 momentum, 0.0005 weight decay to fine-tune our DSFD model. The batch size is set to 16. The learning rate is set to 10 ?3 for the first 40k steps, and we decay it to 10 ?4 and 10 ?5 for two 10k steps.
During inference, the first shot's outputs are ignored and the second shot predicts top 5k high confident detections. Non-maximum suppression is applied with jaccard overlap of 0.3 to produce top 750 high confident bounding boxes per image. For 4 bounding box coordinates, we round down top left coordinates and roundup width and height to expand the detection bounding box. The official code has been released at: https://github.com/ TencentYoutuResearch/FaceDetection-DSFD. That means even with a higher threshold (i.e., 0.4), using our IAM, we can still achieve more matched anchors. Here, we choose a slightly higher threshold in IAM so that to better balance the number and quality of the matched faces.

Analysis on DSFD
In this subsection, we conduct extensive experiments and ablation studies on the WIDER FACE dataset to evaluate the effectiveness of several contributions of our proposed framework, including feature enhance module, progressive anchor loss, and improved anchor matching. For fair comparisons, we use the same parameter settings for all the experiments, except for the specified changes to the components. All models are trained on the WIDER FACE training set and evaluated on validation set. To better understand DSFD, we select different baselines to ablate each component on how this part affects the final performance. Feature Enhance Module First, We adopt anchor designed in S3FD, PyramidBox and six original feature maps generated by VGG16 to perform classification and regression, which is named Face SSD (FSSD) as the baseline. We then use VGG16-based FSSD as the baseline to add feature enchance module for comparison. shows that our feature enhance module can improve VGG16-based FSSD from 92.6%, 90.2%, 79.1% to 93.0%, 91.4%, 84.6%. Progressive Anchor Loss Second, we use Res50-based FSSD as the baseline to add progressive anchor loss for comparison. We use four residual blocks' ouputs in ResNet to replace the outputs of conv3 3, conv4 3, conv5 3, conv fc7 in VGG. Except for VGG16, we do not perform layer normalization. shows our progressive anchor loss can improve Res50-based FSSD using FEM from 95.0%, 94.1%, 88.0% to 95.3%, 94.4%, 88.6%. Improved Anchor Matching To evaluate our improved anchor matching strategy, we use Res101-based FSSD without anchor compensation as the baseline. shows that our improved anchor matching can improve Res101based FSSD using FEM from 95.8%, 95.1%, 89.7% to 96.1%, 95.2%, 90.0%. Finally, we can improve our DSFD to 96.6%, 95.7%, 90.4% with ResNet152 as the backbone.     Besides, shows that our improved anchor matching strategy greatly increases the number of ground truth faces that are closed to the anchor, which can reduce the contradiction between the discrete anchor scales and continuous face scales. Moreover, shows the number distribution of matched anchor number for ground truth faces, which indicates our improved anchor matching can significantly increase the matched anchor number, and the averaged number of matched anchor for different scales of faces can be improved from 6.4 to about 6.9.
Comparison with RFB Our FEM differs from RFB in two aspects. First, our FEM is based on FPN to make full use of feature information from different spatial levels, while RFB ignores. Second, our FEM adopts stacked dilation convolutions in a multi-branch structure, which efficiently leads to larger Receptive Fields (RF) than RFB that only uses one dilation layer in each branch, e.g., R 3 in FEM compared to R in RFB where indicates the RF of one dilation convolution. Tab. 6 clearly demonstrates the superiority of our FEM over RFB, even when RFB is equipped with FPN.
From the above analysis and results, some promising conclusions can be drawn: 1) Feature enhance is crucial. We use a more robust and discriminative feature enhance module to improve the feature presentation ability, especially for hard face. 2) Auxiliary loss based on progressive  anchor is used to train all 12 different scale detection feature maps, and it improves the performance on easy, medium and hard faces simultaneously. 3) Our improved anchor matching provides better initial anchors and ground-truth faces to regress anchor from faces, which achieves the improvements of 0.3%, 0.1%, 0.3% on three settings, respectively. Additionally, when we enlarge the training batch size (i.e., LargeBS), the result in hard setting can get 91.2% AP.

Effects of Different Backbones
To better understand our DSFD, we further conducted experiments to examine how different backbones affect classification and detection performance. Specifically, we use the same setting except for the feature extraction network, we implement SE-ResNet101, DPN?98, SE-ResNeXt101 32×4d following the ResNet101 setting in our DSFD. From, DSFD with SE-ResNeXt101 32×4d got 95.7%, 94.8%, 88.9%, on easy, medium and hard settings respectively, which indicates that more complexity model and higher Top-1 Ima-geNet classification accuracy may not benefit face detection AP. Therefore, in our DSFD framework, better performance on classification are not necessary for better performance on detection, which is consistent to the conclusion claimed in. Our DSFD enjoys high inference speed benefited from simply using the second shot detection results.
For VGA resolution inputs to Res50-based DSFD, it runs 22 FPS on NVIDA GPU P40 during inference.

Comparisons with State-of-the-Art Methods
We evaluate the proposed DSFD on two popular face detection benchmarks, including WIDER FACE and Face Detection Data Set and Benchmark (FDDB). Our model is trained only using the training set of WIDER FACE, and then evaluated on both benchmarks without any further fine-tuning. We also follow the similar way used in to build the image pyramid for multi-scale testing and use more powerful backbone similar as. WIDER FACE Dataset It contains 393, 703 annotated faces with large variations in scale, pose and occlusion in total 32, 203 images. For each of the 60 event classes, 40%, 10%, 50% images of the database are randomly selected as training, validation and testing sets. Besides, each subset is further defined into three levels of difficulty: 'Easy', 'Medium', 'Hard' based on the detection rate of a baseline detector. As shown in, our DSFD achieves the best performance among all of the state-of-the-art face detectors based on the average precision (AP) across the three subsets, i.e., 96.6% (Easy), 95.7% (Medium) and 90.4% (Hard) on validation set, and 96.0% (Easy), 95.3% (Medium) and 90.0% (Hard) on test set. shows more examples to demonstrate the effects of DSFD on handling faces with various variations, in which the blue bounding boxes indicate the detector confidence is above 0.8.
FDDB Dataset It contains 5, 171 faces in 2, 845 images taken from the faces in the wild data set. Since WIDER FACE has bounding box annotation while faces in FDDB are represented by ellipses, we learn a post-hoc ellipses regressor to transform the final prediction results. As shown in, our DSFD achieves state-of-the-art performance on both discontinuous and continuous ROC curves, i.e. 99.1% and 86.2% when the number of false positives equals to 1, 000. After adding additional annotations to those unlabeled faces, the false positives of our model can be further reduced and outperform all other methods.

Conclusions
This paper introduces a novel face detector named Dual Shot Face Detector (DSFD). In this work, we propose a novel Feature Enhance Module that utilizes different level information and thus obtains more discriminability and robustness features. Auxiliary supervisions introduced in early layers by using smaller anchors are adopted to effectively facilitate the features. Moreover, an improved anchor matching method is introduced to match anchors and ground truth faces as far as possible to provide better initialization for the regressor. Comprehensive experiments are conducted on popular face detection benchmarks, FDDB and WIDER FACE, to demonstrate the superiority of our proposed DSFD compared with the state-of-the-art face detectors, e.g., SRN and PyramidBox.